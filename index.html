<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sabor Digital - Men√∫ & Pedidos</title>
    
    <!-- Tailwind CSS (Dise√±o) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons (Iconos) -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Supabase Client (Base de Datos) -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; -webkit-tap-highlight-color: transparent; }
        
        /* Ocultar scrollbar pero mantener funcionalidad */
        .hide-scroll::-webkit-scrollbar { display: none; }
        .hide-scroll { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Animaciones suaves */
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        /* Modal Styles */
        .modal-backdrop { opacity: 0; visibility: hidden; transition: all 0.3s ease; }
        .modal-backdrop.active { opacity: 1; visibility: visible; }
        .modal-panel { transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        .modal-backdrop.active .modal-panel { transform: translateY(0); }
        
        /* Ajustes Mobile */
        .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
    </style>
</head>
<body class="text-gray-800 antialiased selection:bg-orange-100 selection:text-orange-600">

    <div id="app" class="pb-24 min-h-screen flex flex-col">
        <!-- Navbar Sticky -->
        <nav class="sticky top-0 z-40 bg-white/90 backdrop-blur-md border-b border-gray-100">
            <div class="max-w-md mx-auto px-4 h-16 flex items-center justify-between">
                <div class="flex items-center gap-2 cursor-pointer active:scale-95 transition-transform" onclick="app.router('menu')">
                    <div class="bg-gradient-to-tr from-orange-500 to-red-500 p-1.5 rounded-lg text-white shadow-sm">
                        <i data-lucide="utensils-crossed" width="20"></i>
                    </div>
                    <span class="font-bold text-lg text-gray-900 tracking-tight">Sabor Digital</span>
                </div>
                
                <div class="flex items-center gap-3">
                    <!-- Bot√≥n Admin (Desktop/Hidden on load) -->
                    <button onclick="app.router('login')" class="hidden md:block text-xs font-bold text-gray-500 hover:text-orange-600 uppercase tracking-wide">
                        Admin Area
                    </button>
                    
                    <!-- Bot√≥n Carrito -->
                    <button onclick="app.toggleCart()" class="relative p-2.5 text-gray-600 hover:bg-gray-50 rounded-full transition-colors active:scale-90">
                        <i data-lucide="shopping-bag" width="22"></i>
                        <span id="cart-badge" class="hidden absolute top-0.5 right-0.5 bg-red-500 text-white text-[10px] font-bold h-5 min-w-[1.25rem] px-1 flex items-center justify-center rounded-full border-2 border-white shadow-sm">0</span>
                    </button>
                </div>
            </div>
        </nav>

        <!-- Contenedor Principal -->
        <main id="main-content" class="flex-grow fade-in w-full max-w-md mx-auto"></main>

        <!-- Footer -->
        <footer class="mt-auto border-t bg-white py-8 text-center">
            <p class="text-xs text-gray-400 mb-2">¬© 2025 Sabor Digital</p>
            <div id="connection-status" class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full bg-gray-100 text-[10px] font-medium text-gray-500">
                <div class="w-2 h-2 rounded-full bg-gray-400"></div> Verificando conexi√≥n...
            </div>
            <br>
            <button onclick="app.router('login')" class="mt-4 text-[10px] text-gray-300 hover:text-orange-500 transition-colors uppercase font-bold tracking-widest">
                Acceso Propietario
            </button>
        </footer>
    </div>

    <!-- MODAL: Carrito -->
    <div id="cart-modal" class="modal-backdrop fixed inset-0 z-50 flex items-end sm:items-center justify-center">
        <div class="absolute inset-0 bg-black/30 backdrop-blur-sm" onclick="app.toggleCart()"></div>
        <div class="modal-panel bg-white w-full max-w-md h-[85vh] sm:h-auto sm:max-h-[85vh] sm:rounded-2xl shadow-2xl relative z-10 flex flex-col safe-bottom rounded-t-2xl">
            <div class="p-4 border-b flex items-center justify-between bg-white rounded-t-2xl">
                <h2 class="font-bold text-lg flex items-center gap-2 text-gray-900">
                    Tu Pedido <span id="cart-total-count" class="bg-orange-100 text-orange-700 text-xs px-2 py-0.5 rounded-full">0</span>
                </h2>
                <button onclick="app.toggleCart()" class="p-2 bg-gray-50 hover:bg-gray-100 rounded-full text-gray-500 transition-colors">
                    <i data-lucide="x" width="20"></i>
                </button>
            </div>
            
            <div id="cart-items" class="flex-grow overflow-y-auto p-4 space-y-4">
                <!-- Items inyectados -->
            </div>

            <div id="cart-footer" class="p-4 border-t bg-gray-50 safe-bottom">
                <!-- Totales y Checkout -->
            </div>
        </div>
    </div>

    <!-- MODAL: Admin Form -->
    <div id="admin-modal" class="hidden fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm animate-in fade-in duration-200">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden animate-in zoom-in-95 duration-200">
            <div class="px-5 py-4 border-b flex justify-between items-center bg-gray-50">
                <h3 id="form-title" class="font-bold text-gray-800">Gestionar √çtem</h3>
                <button onclick="app.closeAdminModal()" class="text-gray-400 hover:text-gray-600"><i data-lucide="x" width="20"></i></button>
            </div>
            <form id="admin-form" onsubmit="app.handleFormSubmit(event)" class="p-5 space-y-4"></form>
        </div>
    </div>

    <!-- L√ìGICA DE LA APLICACI√ìN -->
    <script>
        const app = {
            // ============================================================
            // üöÄ TUS CREDENCIALES YA CONFIGURADAS
            // ============================================================
            config: {
                supabaseUrl: "https://ymxvscnevnhimlkhvddo.supabase.co",
                supabaseKey: "sb_publishable_afQl91l_8f2-qFpmUztSew_ULSGTPph"
            },
            
            // Estado de la aplicaci√≥n
            state: {
                view: 'menu',
                user: null, // Admin user state
                cart: [],
                activeCategory: 'Todos',
                categories: [
                    { id: 1, name: "Hamburguesas" }, { id: 2, name: "Pizzas" }, { id: 3, name: "Bebidas" }
                ],
                products: [
                    // Datos de ejemplo iniciales (se reemplazar√°n con los reales de la base de datos)
                    { id: 101, name: "Hamburguesa Demo", description: "Cargando productos reales...", price: 0.00, category: "Hamburguesas", image: "https://images.unsplash.com/photo-1568901346375-23c9450c58cd", available: true }
                ],
                editingItem: null,
                collectionType: 'products', // 'products' o 'categories'
                supabase: null,
                useMock: true
            },

            // Inicializaci√≥n
            init: async () => {
                if (app.config.supabaseUrl && app.config.supabaseKey) {
                    try {
                        app.state.supabase = window.supabase.createClient(app.config.supabaseUrl, app.config.supabaseKey);
                        app.state.useMock = false;
                        
                        // Actualizar indicador visual
                        const statusEl = document.getElementById('connection-status');
                        statusEl.className = "inline-flex items-center gap-1.5 px-3 py-1 rounded-full bg-green-100 text-[10px] font-medium text-green-700";
                        statusEl.innerHTML = `<div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div> Conectado`;

                        await app.loadData();
                        app.setupRealtime();
                    } catch (e) {
                        console.error("Error Supabase:", e);
                        const statusEl = document.getElementById('connection-status');
                        statusEl.className = "inline-flex items-center gap-1.5 px-3 py-1 rounded-full bg-red-100 text-[10px] font-medium text-red-700";
                        statusEl.innerHTML = `<div class="w-2 h-2 rounded-full bg-red-500"></div> Error Conexi√≥n`;
                    }
                }
                lucide.createIcons();
                app.render();
            },

            // Carga de datos
            loadData: async () => {
                if(app.state.useMock) return;

                const { data: cats, error: errCats } = await app.state.supabase.from('categories').select('*').order('id');
                if(!errCats && cats) app.state.categories = cats;

                const { data: prods, error: errProds } = await app.state.supabase.from('products').select('*').order('id');
                if(!errProds && prods) app.state.products = prods;
                
                app.render();
            },

            // Suscripci√≥n a cambios en tiempo real
            setupRealtime: () => {
                app.state.supabase.channel('public-db')
                    .on('postgres_changes', { event: '*', schema: 'public', table: 'products' }, payload => app.handleUpdate('products', payload))
                    .on('postgres_changes', { event: '*', schema: 'public', table: 'categories' }, payload => app.handleUpdate('categories', payload))
                    .subscribe();
            },

            handleUpdate: (table, payload) => {
                const list = table === 'products' ? app.state.products : app.state.categories;
                if (payload.eventType === 'INSERT') list.push(payload.new);
                else if (payload.eventType === 'UPDATE') {
                    const idx = list.findIndex(i => i.id === payload.new.id);
                    if (idx !== -1) list[idx] = payload.new;
                } else if (payload.eventType === 'DELETE') {
                    const idx = list.findIndex(i => i.id === payload.old.id);
                    if (idx !== -1) list.splice(idx, 1);
                }
                app.render();
            },

            // Renderizado Principal
            render: () => {
                const main = document.getElementById('main-content');
                if (app.state.view === 'menu') app.renderMenu(main);
                else if (app.state.view === 'login') app.renderLogin(main);
                else if (app.state.view === 'admin') app.renderAdmin(main);
                lucide.createIcons();
            },

            renderMenu: (container) => {
                const { products, categories, activeCategory } = app.state;
                const filtered = activeCategory === 'Todos' ? products : products.filter(p => p.category === activeCategory);

                container.innerHTML = `
                    <!-- Hero -->
                    <div class="relative bg-gray-900 text-white px-6 py-12 mb-6 overflow-hidden sm:rounded-b-3xl shadow-xl">
                        <div class="absolute top-0 right-0 w-64 h-64 bg-gradient-to-br from-orange-500 to-pink-500 rounded-full blur-[80px] opacity-40 transform translate-x-1/3 -translate-y-1/2"></div>
                        <div class="relative z-10">
                            <span class="text-orange-400 font-bold text-xs tracking-wider uppercase mb-2 block">Men√∫ Digital</span>
                            <h1 class="text-3xl font-bold mb-2 leading-tight">¬øQu√© se te antoja <br>hoy? üçî</h1>
                        </div>
                    </div>

                    <!-- Categories -->
                    <div class="sticky top-16 z-30 bg-white/95 backdrop-blur-sm border-b border-gray-100 py-3 mb-6">
                        <div class="px-4 overflow-x-auto hide-scroll flex gap-2">
                            <button onclick="app.setCategory('Todos')" class="whitespace-nowrap px-4 py-2 rounded-full text-xs font-bold transition-all ${activeCategory === 'Todos' ? 'bg-gray-900 text-white shadow-lg shadow-gray-200 scale-105' : 'bg-gray-100 text-gray-500 hover:bg-gray-200'}">Todos</button>
                            ${categories.map(c => `
                                <button onclick="app.setCategory('${c.name}')" class="whitespace-nowrap px-4 py-2 rounded-full text-xs font-bold transition-all ${activeCategory === c.name ? 'bg-orange-500 text-white shadow-lg shadow-orange-200 scale-105' : 'bg-gray-100 text-gray-500 hover:bg-gray-200'}">
                                    ${c.name}
                                </button>
                            `).join('')}
                        </div>
                    </div>

                    <!-- Products Grid -->
                    <div class="px-4 grid grid-cols-1 gap-6 pb-10">
                        ${filtered.map(p => `
                            <div class="group bg-white rounded-2xl p-3 shadow-sm border border-gray-100 flex gap-4 hover:shadow-md transition-shadow">
                                <div class="relative w-28 h-28 flex-shrink-0 rounded-xl overflow-hidden bg-gray-100">
                                    <img src="${p.image}" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500" onerror="this.src='https://via.placeholder.com/150?text=Sin+Foto'">
                                    ${!p.available ? '<div class="absolute inset-0 bg-black/60 flex items-center justify-center"><span class="text-[10px] font-bold text-white uppercase tracking-wider">Agotado</span></div>' : ''}
                                </div>
                                <div class="flex flex-col flex-grow justify-between py-1">
                                    <div>
                                        <div class="flex justify-between items-start">
                                            <h3 class="font-bold text-gray-800 leading-tight">${p.name}</h3>
                                            <span class="font-bold text-orange-600 text-sm">$${Number(p.price).toFixed(2)}</span>
                                        </div>
                                        <p class="text-gray-400 text-xs mt-1 line-clamp-2">${p.description || ''}</p>
                                    </div>
                                    <button onclick="app.addToCart(${p.id})" ${!p.available ? 'disabled' : ''} class="mt-3 w-full py-2 rounded-lg text-xs font-bold flex items-center justify-center gap-2 transition-all ${p.available ? 'bg-gray-900 text-white hover:bg-gray-800 active:scale-95' : 'bg-gray-100 text-gray-400 cursor-not-allowed'}">
                                        ${p.available ? 'Agregar <i data-lucide="plus" width="14"></i>' : 'No disponible'}
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                        ${filtered.length === 0 ? '<div class="text-center py-12 text-gray-400"><i data-lucide="coffee" class="mx-auto mb-2 opacity-20" width="40"></i><p class="text-sm">No hay productos aqu√≠.</p></div>' : ''}
                    </div>
                `;
            },

            renderLogin: (container) => {
                container.innerHTML = `
                    <div class="min-h-[70vh] flex flex-col items-center justify-center px-6 animate-in zoom-in-95 duration-300">
                        <div class="bg-gradient-to-br from-gray-800 to-gray-900 w-16 h-16 rounded-2xl rotate-3 flex items-center justify-center mb-6 shadow-xl shadow-gray-200">
                            <i data-lucide="shield-check" class="text-white" width="32"></i>
                        </div>
                        <h2 class="text-2xl font-bold text-gray-900 mb-2">Panel de Control</h2>
                        <p class="text-gray-400 text-sm mb-8 text-center">Ingresa tu PIN de seguridad para gestionar el men√∫.</p>
                        
                        <form onsubmit="app.handleLogin(event)" class="w-full max-w-xs space-y-4">
                            <input type="password" id="pin-input" placeholder="PIN (1234)" class="w-full text-center text-3xl tracking-[0.5em] font-bold px-4 py-4 bg-white border-2 border-gray-100 rounded-2xl focus:border-orange-500 focus:ring-0 outline-none transition-colors text-gray-800 placeholder:text-gray-200" maxlength="4" inputmode="numeric">
                            <button type="submit" class="w-full bg-orange-500 hover:bg-orange-600 text-white font-bold py-4 rounded-xl shadow-lg shadow-orange-200 active:scale-[0.98] transition-all">
                                Ingresar
                            </button>
                        </form>
                        <button onclick="app.router('menu')" class="mt-8 text-sm text-gray-400 hover:text-gray-600 font-medium">Cancelar y volver</button>
                    </div>
                `;
            },

            renderAdmin: (container) => {
                const list = app.state.collectionType === 'products' ? app.state.products : app.state.categories;
                container.innerHTML = `
                    <div class="px-4 py-6">
                        <div class="flex justify-between items-center mb-6">
                            <div>
                                <h1 class="text-xl font-bold text-gray-900">Administraci√≥n</h1>
                                <p class="text-xs text-gray-400">Gestiona tu inventario en tiempo real</p>
                            </div>
                            <button onclick="app.router('menu')" class="bg-gray-100 p-2 rounded-lg text-gray-500 hover:text-red-500 hover:bg-red-50 transition-colors">
                                <i data-lucide="log-out" width="20"></i>
                            </button>
                        </div>

                        <!-- Tabs -->
                        <div class="flex p-1 bg-gray-100 rounded-xl mb-6">
                            <button onclick="app.setAdminTab('products')" class="flex-1 py-2 rounded-lg text-xs font-bold transition-all ${app.state.collectionType === 'products' ? 'bg-white text-gray-900 shadow-sm' : 'text-gray-500'}">Productos</button>
                            <button onclick="app.setAdminTab('categories')" class="flex-1 py-2 rounded-lg text-xs font-bold transition-all ${app.state.collectionType === 'categories' ? 'bg-white text-gray-900 shadow-sm' : 'text-gray-500'}">Categor√≠as</button>
                        </div>

                        <!-- List -->
                        <div class="space-y-3 pb-20">
                            <div class="flex justify-between items-center px-1">
                                <span class="text-xs font-bold text-gray-400 uppercase tracking-wider">${list.length} Elementos</span>
                                <button onclick="app.openAdminModal()" class="bg-gray-900 text-white px-4 py-2 rounded-lg text-xs font-bold flex items-center gap-2 active:scale-95 transition-transform">
                                    <i data-lucide="plus" width="14"></i> Crear Nuevo
                                </button>
                            </div>

                            ${list.map(item => `
                                <div class="bg-white p-3 rounded-xl border border-gray-100 flex items-center gap-3 shadow-sm">
                                    ${app.state.collectionType === 'products' ? 
                                        `<img src="${item.image}" class="w-12 h-12 rounded-lg bg-gray-50 object-cover border border-gray-100" onerror="this.src='https://via.placeholder.com/50'">` : 
                                        `<div class="w-12 h-12 rounded-lg bg-orange-50 text-orange-500 flex items-center justify-center font-bold text-lg">${item.name.charAt(0)}</div>`
                                    }
                                    <div class="flex-grow min-w-0">
                                        <h4 class="font-bold text-gray-800 text-sm truncate">${item.name}</h4>
                                        ${app.state.collectionType === 'products' ? 
                                            `<p class="text-xs text-gray-400">$${item.price} ‚Ä¢ ${item.category}</p>` : 
                                            '<p class="text-xs text-gray-400">Categor√≠a</p>'
                                        }
                                    </div>
                                    <div class="flex gap-1">
                                        <button onclick="app.editItem(${item.id})" class="p-2 text-blue-500 bg-blue-50 rounded-lg hover:bg-blue-100"><i data-lucide="edit-2" width="16"></i></button>
                                        <button onclick="app.deleteItem(${item.id})" class="p-2 text-red-500 bg-red-50 rounded-lg hover:bg-red-100"><i data-lucide="trash-2" width="16"></i></button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            },

            // Acciones y Helpers
            router: (view) => { app.state.view = view; window.scrollTo(0,0); app.render(); },
            setCategory: (cat) => { app.state.activeCategory = cat; app.render(); },
            setAdminTab: (tab) => { app.state.collectionType = tab; app.render(); },

            // Carrito
            addToCart: (id) => {
                const prod = app.state.products.find(p => p.id === id);
                const item = app.state.cart.find(i => i.id === id);
                if(item) item.qty++;
                else app.state.cart.push({...prod, qty: 1});
                app.updateCartUI();
                app.toggleCart();
            },
            
            updateCartQty: (id, delta) => {
                const item = app.state.cart.find(i => i.id === id);
                if(item) {
                    item.qty += delta;
                    if(item.qty <= 0) app.state.cart = app.state.cart.filter(i => i.id !== id);
                    app.updateCartUI();
                }
            },

            toggleCart: () => {
                document.getElementById('cart-modal').classList.toggle('active');
            },

            updateCartUI: () => {
                const count = app.state.cart.reduce((a,b) => a + b.qty, 0);
                const badge = document.getElementById('cart-badge');
                const totalCountEl = document.getElementById('cart-total-count');
                
                badge.innerText = count;
                badge.classList.toggle('hidden', count === 0);
                if(totalCountEl) totalCountEl.innerText = count;

                const list = document.getElementById('cart-items');
                if(!list) return;

                if(app.state.cart.length === 0) {
                    list.innerHTML = `
                        <div class="h-full flex flex-col items-center justify-center text-gray-300 space-y-4">
                            <i data-lucide="shopping-basket" width="64" class="opacity-20"></i>
                            <p class="font-medium">Tu carrito est√° vac√≠o</p>
                            <button onclick="app.toggleCart()" class="text-orange-500 font-bold text-sm">Explorar Men√∫</button>
                        </div>`;
                    document.getElementById('cart-footer').innerHTML = '';
                } else {
                    list.innerHTML = app.state.cart.map(i => `
                        <div class="flex gap-4 items-center bg-white p-2 rounded-xl border border-gray-50">
                            <img src="${i.image}" class="w-16 h-16 rounded-lg object-cover bg-gray-100">
                            <div class="flex-grow">
                                <h4 class="font-bold text-gray-800 text-sm line-clamp-1">${i.name}</h4>
                                <p class="text-xs text-gray-400 mb-2">$${Number(i.price).toFixed(2)} u.</p>
                                <div class="flex items-center gap-3 bg-gray-50 w-fit rounded-lg p-1">
                                    <button onclick="app.updateCartQty(${i.id}, -1)" class="w-6 h-6 flex items-center justify-center bg-white rounded shadow-sm text-gray-600 hover:text-red-500 font-bold">-</button>
                                    <span class="text-xs font-bold w-4 text-center">${i.qty}</span>
                                    <button onclick="app.updateCartQty(${i.id}, 1)" class="w-6 h-6 flex items-center justify-center bg-white rounded shadow-sm text-gray-600 hover:text-green-500 font-bold">+</button>
                                </div>
                            </div>
                            <div class="text-right">
                                <span class="font-bold text-gray-900">$${(i.price * i.qty).toFixed(2)}</span>
                            </div>
                        </div>
                    `).join('');

                    const total = app.state.cart.reduce((a,b) => a + (b.price * b.qty), 0);
                    document.getElementById('cart-footer').innerHTML = `
                        <div class="flex justify-between items-end mb-4">
                            <span class="text-gray-500 font-medium text-sm">Total a pagar</span>
                            <span class="text-2xl font-bold text-gray-900">$${total.toFixed(2)}</span>
                        </div>
                        <button onclick="app.checkout()" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-4 rounded-xl shadow-lg shadow-green-200 flex items-center justify-center gap-2 active:scale-[0.98] transition-transform">
                            <i data-lucide="message-circle" width="20"></i> Enviar Pedido por WhatsApp
                        </button>
                    `;
                    lucide.createIcons();
                }
            },

            checkout: () => {
                const phone = "593999999999"; // CAMBIA ESTO POR TU N√öMERO
                let msg = "üëã Hola, quiero hacer un pedido:\n\n";
                app.state.cart.forEach(i => msg += `‚ñ´Ô∏è ${i.qty}x ${i.name} ($${(i.price*i.qty).toFixed(2)})\n`);
                const total = app.state.cart.reduce((a,b) => a + (b.price * b.qty), 0);
                msg += `\nüí∞ *Total: $${total.toFixed(2)}*`;
                window.open(`https://wa.me/${phone}?text=${encodeURIComponent(msg)}`, '_blank');
            },

            // Admin Logic
            handleLogin: (e) => {
                e.preventDefault();
                const pin = document.getElementById('pin-input').value;
                if(pin === '1234') app.router('admin');
                else alert('PIN Incorrecto');
            },

            openAdminModal: () => {
                app.state.editingItem = null;
                app.renderForm();
                document.getElementById('admin-modal').classList.remove('hidden');
            },
            
            closeAdminModal: () => document.getElementById('admin-modal').classList.add('hidden'),

            editItem: (id) => {
                const list = app.state.collectionType === 'products' ? app.state.products : app.state.categories;
                app.state.editingItem = list.find(i => i.id === id);
                app.renderForm();
                document.getElementById('admin-modal').classList.remove('hidden');
            },

            renderForm: () => {
                const item = app.state.editingItem || {};
                const isProd = app.state.collectionType === 'products';
                document.getElementById('form-title').innerText = item.id ? 'Editar Elemento' : 'Nuevo Elemento';
                
                let html = '';
                if(isProd) {
                    html = `
                        <div><label class="text-xs font-bold text-gray-500 uppercase block mb-1">Nombre</label>
                        <input required name="name" value="${item.name||''}" class="w-full bg-gray-50 border-gray-200 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-orange-500 outline-none"></div>
                        
                        <div class="grid grid-cols-2 gap-3">
                            <div><label class="text-xs font-bold text-gray-500 uppercase block mb-1">Precio</label>
                            <input required type="number" step="0.01" name="price" value="${item.price||''}" class="w-full bg-gray-50 border-gray-200 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-orange-500 outline-none"></div>
                            
                            <div><label class="text-xs font-bold text-gray-500 uppercase block mb-1">Categor√≠a</label>
                            <select name="category" class="w-full bg-gray-50 border-gray-200 rounded-lg px-3 py-2 text-sm outline-none">
                                ${app.state.categories.map(c => `<option ${item.category===c.name?'selected':''}>${c.name}</option>`).join('')}
                            </select></div>
                        </div>

                        <div><label class="text-xs font-bold text-gray-500 uppercase block mb-1">Descripci√≥n</label>
                        <textarea required name="description" rows="2" class="w-full bg-gray-50 border-gray-200 rounded-lg px-3 py-2 text-sm outline-none">${item.description||''}</textarea></div>

                        <div><label class="text-xs font-bold text-gray-500 uppercase block mb-1">Imagen URL</label>
                        <input required name="image" value="${item.image||''}" class="w-full bg-gray-50 border-gray-200 rounded-lg px-3 py-2 text-sm outline-none" placeholder="https://..."></div>
                    `;
                } else {
                    html = `
                        <div><label class="text-xs font-bold text-gray-500 uppercase block mb-1">Nombre Categor√≠a</label>
                        <input required name="name" value="${item.name||''}" class="w-full bg-gray-50 border-gray-200 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-orange-500 outline-none"></div>
                    `;
                }

                html += `<button type="submit" class="w-full bg-orange-500 text-white font-bold py-3 rounded-xl mt-4 hover:bg-orange-600 transition-colors">Guardar Cambios</button>`;
                document.getElementById('admin-form').innerHTML = html;
            },

            handleFormSubmit: async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const data = Object.fromEntries(formData.entries());
                
                if(data.price) {
                    data.price = parseFloat(data.price);
                    data.available = true;
                }

                // Guardar
                if(app.state.useMock) {
                    alert("Modo Demo: No se puede guardar sin las claves de Supabase.");
                } else {
                    try {
                        const table = app.state.collectionType;
                        const { error } = app.state.editingItem 
                            ? await app.state.supabase.from(table).update(data).eq('id', app.state.editingItem.id)
                            : await app.state.supabase.from(table).insert([data]);
                            
                        if(error) throw error;
                    } catch(err) {
                        alert("Error guardando: " + err.message);
                    }
                }
                app.closeAdminModal();
            },

            deleteItem: async (id) => {
                if(!confirm("¬øEliminar este elemento?")) return;
                
                if(app.state.useMock) {
                    alert("Modo Demo: No se puede borrar.");
                } else {
                    const { error } = await app.state.supabase.from(app.state.collectionType).delete().eq('id', id);
                    if(error) alert("Error borrando: " + error.message);
                }
            }
        };

        // Arrancar app
        app.init();
    </script>
</body>
</html>


